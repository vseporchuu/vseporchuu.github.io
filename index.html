<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tanki Online 47bot</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Ваши стили остаются без изменений */
        :root {
            --primary: #4DB6AC;
            --primary-dark: #00897B;
            --primary-light: #B2DFDB;
            --accent: #FF9800;
            --text: #263238;
            --text-light: #78909C;
            --bg: #F5F7FA;
            --card-bg: #FFFFFF;
            --divider: #E0E0E0;
            --error: #F44336;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Roboto', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            padding: 16px;
            padding-bottom: 80px;
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            width: 100%;
            position: relative;
        }
        
        /* ... ВСЕ ВАШИ СТИЛИ БЕЗ ИЗМЕНЕНИЙ ... */
        
        /* Ваши стили остаются здесь */
        
    </style>
</head>
<body>
    <div class="loader-container" id="loader">
        <div class="loader"></div>
    </div>
    
    <div class="container">
        <!-- шапка профиля -->
        <div class="profile-header" id="profileHeader">
            <div class="profile-avatar" id="userAvatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="profile-info">
                <div class="profile-name" id="userName">Загрузка...</div>
                <div class="tanki-info">
                    <div class="tanki-rank" id="tankiRank">Чат статистика</div>
                    <div class="tanki-nickname" id="tankiNickname"></div>
                </div>
            </div>
        </div>
        
        <!-- поиск пользователя -->
        <div class="search-container" id="userSearchContainer">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" id="userSearchInput" placeholder="Поиск пользователя">
        </div>
        
        <!-- контейнеры вкладок -->
        <div class="tab-content active" id="homeTab">
            <!-- ... Ваш контент вкладки "Главная" ... -->
        </div>
        
        <!-- вкладка "Профиль" -->
        <div class="tab-content" id="gameTab">
            <!-- ... Ваш контент вкладки "Профиль" ... -->
        </div>
        
        <!-- вкладка "Общее" -->
        <div class="tab-content" id="commonTab">
            <!-- ... Ваш контент вкладки "Общее" ... -->
        </div>
        
        <!-- вкладка "Рейтинг" -->
        <div class="tab-content" id="ratingTab">
            <!-- ... Ваш контент вкладки "Рейтинг" ... -->
        </div>
        
        <!-- вкладка "Настройки" -->
        <div class="tab-content" id="settingsTab">
            <!-- ... Ваш контент вкладки "Настройки" ... -->
        </div>
        
        <!-- нижняя панель -->
        <div class="nav-tabs">
            <div class="tab-item active" data-tab="homeTab">
                <i class="fas fa-home"></i>
                <span>Главная</span>
            </div>
            <div class="tab-item" data-tab="gameTab">
                <i class="fas fa-user"></i>
                <span>Профиль</span>
            </div>
            <div class="tab-item" data-tab="commonTab">
                <i class="fas fa-th-large"></i>
                <span>Общее</span>
            </div>
            <div class="tab-item" data-tab="ratingTab">
                <i class="fas fa-trophy"></i>
                <span>Рейтинг</span>
            </div>
            <div class="tab-item" data-tab="settingsTab">
                <i class="fas fa-cog"></i>
                <span>Настройки</span>
            </div>
        </div>
    </div>
    
    <!-- уведомление -->
    <div class="toast" id="toast">
        <i class="fas fa-info-circle"></i>
        <span id="toastMessage">Сообщение</span>
    </div>
    
    <script>
        // ============== КОНФИГУРАЦИЯ ==============
        // Замените этот URL на адрес вашего бэкенда на Amvera
        const API_BASE_URL = "https://ваш-бота-на-amvera.ru";
        // Замените на ваш секретный ключ (должен совпадать с ключом в настройках Amvera)
        const API_SECRET_KEY = "ваш-секретный-ключ";
        
        // ============== ИНИЦИАЛИЗАЦИЯ ==============
        const tg = window.Telegram.WebApp;
        const bot = tg.initDataUnsafe.bot;
        
        // Элементы интерфейса
        const elements = {
            userName: document.getElementById('userName'),
            userAvatar: document.getElementById('userAvatar'),
            tankiRank: document.getElementById('tankiRank'),
            tankiNickname: document.getElementById('tankiNickname'),
            nicknameInput: document.getElementById('nicknameInput'),
            bindBtn: document.getElementById('bindBtn'),
            errorMessage: document.getElementById('errorMessage'),
            errorText: document.getElementById('errorText'),
            toast: document.getElementById('toast'),
            toastMessage: document.getElementById('toastMessage'),
            chatRank: document.getElementById('chatRank'),
            chatXP: document.getElementById('chatXP'),
            messagesCount: document.getElementById('messagesCount'),
            karmaPoints: document.getElementById('karmaPoints'),
            rankProgressBar: document.getElementById('rankProgressBar'),
            currentXP: document.getElementById('currentXP'),
            nextRankXP: document.getElementById('nextRankXP'),
            penaltyPoints: document.getElementById('penaltyPoints'),
            mutesCount: document.getElementById('mutesCount'),
            lastViolations: document.getElementById('lastViolations'),
            achievementsContainer: document.getElementById('achievementsContainer'),
            themeSwitch: document.getElementById('themeSwitch'),
            privacySwitch: document.getElementById('privacySwitch'),
            showGameAccount: document.getElementById('showGameAccount'),
            ratingNicknameInput: document.getElementById('ratingNicknameInput'),
            ratingSearchBtn: document.getElementById('ratingSearchBtn'),
            ratingErrorMessage: document.getElementById('ratingErrorMessage'),
            ratingErrorText: document.getElementById('ratingErrorText'),
            playerStats: document.getElementById('playerStats'),
            playerRatings: document.getElementById('playerRatings'),
            playerTops: document.getElementById('playerTops'),
            playerSupplies: document.getElementById('playerSupplies'),
            achievementsCard: document.getElementById('achievementsCard'),
            achievementsGrid: document.getElementById('achievementsGrid'),
            loader: document.getElementById('loader'),
            battlesStat: document.getElementById('battlesStat'),
            winsStat: document.getElementById('winsStat'),
            winrateStat: document.getElementById('winrateStat'),
            destroyedStat: document.getElementById('destroyedStat'),
            experienceStat: document.getElementById('experienceStat'),
            repairKit: document.getElementById('repairKit'),
            armor: document.getElementById('armor'),
            doubleDamage: document.getElementById('doubleDamage'),
            speedBoost: document.getElementById('speedBoost'),
            mine: document.getElementById('mine'),
            grenade: document.getElementById('grenade'),
            goldBox: document.getElementById('goldBox'),
            overdrive: document.getElementById('overdrive'),
            userSearchInput: document.getElementById('userSearchInput')
        };
        
        // ============== ОСНОВНЫЕ ФУНКЦИИ ==============
        
        // Показать уведомление
        function showToast(message, type = 'info') {
            elements.toast.className = `toast ${type}`;
            elements.toastMessage.textContent = message;
            elements.toast.classList.add('show');
            
            setTimeout(() => {
                elements.toast.classList.remove('show');
            }, 3000);
        }
        
        // Показать/скрыть загрузчик
        function showLoader() {
            elements.loader.style.display = 'flex';
        }
        
        function hideLoader() {
            elements.loader.style.display = 'none';
        }
        
        // Отправка запроса к API
        async function sendApiRequest(data) {
            try {
                showLoader();
                
                // Добавляем информацию о пользователе
                if (tg.initDataUnsafe.user) {
                    data.user_id = tg.initDataUnsafe.user.id;
                }
                
                const response = await fetch(`${API_BASE_URL}/api`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': API_SECRET_KEY
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error(`Ошибка сервера: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                showToast('Ошибка соединения с сервером', 'error');
                return { error: error.message };
            } finally {
                hideLoader();
            }
        }
        
        // Обновление шапки профиля
        function updateProfileHeader(user) {
            if (user) {
                const userName = user.first_name || user.username || 'Пользователь';
                elements.userName.textContent = userName;
                
                if (user.photo_url) {
                    elements.userAvatar.innerHTML = '';
                    const img = document.createElement('img');
                    img.src = user.photo_url;
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.borderRadius = '50%';
                    elements.userAvatar.appendChild(img);
                }
            } else {
                elements.userName.textContent = 'Пользователь Telegram';
            }
        }
        
        // Обновление статистики чата
        function updateChatStats(stats) {
            if (!stats) return;
            
            elements.chatXP.textContent = stats.experience;
            elements.messagesCount.textContent = stats.messages_count;
            elements.karmaPoints.textContent = stats.karma;
            elements.penaltyPoints.textContent = stats.karma;
            elements.mutesCount.textContent = stats.mutes;
            elements.chatRank.textContent = stats.rank;
            
            // Прогресс до следующего звания
            let nextRankXP;
            if (stats.experience < 100) {
                nextRankXP = 100;
            } else if (stats.experience < 300) {
                nextRankXP = 300;
            } else if (stats.experience < 600) {
                nextRankXP = 600;
            } else if (stats.experience < 1000) {
                nextRankXP = 1000;
            } else {
                nextRankXP = stats.experience * 1.5;
            }
            
            elements.currentXP.textContent = stats.experience;
            elements.nextRankXP.textContent = nextRankXP;
            
            const progress = Math.min(100, Math.round((stats.experience / nextRankXP) * 100));
            elements.rankProgressBar.style.width = `${progress}%`;
            
            // Достижения
            updateAchievements(stats.achievements);
            
            // Нарушения
            if (stats.mutes > 0) {
                const violations = [
                    { reason: "Нецензурная лексика", date: new Date().toLocaleDateString() }
                ];
                
                elements.lastViolations.innerHTML = violations.map(v => `
                    <div class="violation-item">
                        <div class="violation-reason">${v.reason}</div>
                        <div class="violation-date">${v.date}</div>
                    </div>
                `).join('');
            }
        }
        
        // Обновление списка достижений
        function updateAchievements(achievements) {
            const achievementIcons = {
                "Первое сообщение": "fas fa-comment",
                "Активный участник": "fas fa-star",
                "Ветеран чата": "fas fa-crown",
                "Репортер": "fas fa-flag"
            };
            
            elements.achievementsContainer.innerHTML = achievements.map(achievement => `
                <div class="achievement-item">
                    <div class="achievement-badge">
                        <i class="${achievementIcons[achievement] || 'fas fa-medal'}"></i>
                    </div>
                    <div class="achievement-name">${achievement}</div>
                </div>
            `).join('');
        }
        
        // Обновление статистики Tanki Online
        function updateTankiStats(stats) {
            if (!stats) return;
            
            // Основная статистика
            elements.battlesStat.textContent = stats.battles.toLocaleString();
            elements.winsStat.textContent = stats.wins.toLocaleString();
            elements.winrateStat.textContent = `${stats.winrate}%`;
            elements.destroyedStat.textContent = stats.kills.toLocaleString();
            elements.experienceStat.textContent = stats.experience.toLocaleString();
            
            // Топы
            updateTopItems('topGunsContainer', stats.turrets, 'fas fa-gun');
            updateTopItems('topHullsContainer', stats.hulls, 'fas fa-shield-alt');
            updateTopItems('topPaintsContainer', stats.paints, 'fas fa-paint-roller');
            
            // Припасы
            if (stats.supplies) {
                elements.repairKit.textContent = stats.supplies.repairKit || 0;
                elements.armor.textContent = stats.supplies.armor || 0;
                elements.doubleDamage.textContent = stats.supplies.doubleDamage || 0;
                elements.speedBoost.textContent = stats.supplies.speedBoost || 0;
                elements.mine.textContent = stats.supplies.mine || 0;
                elements.grenade.textContent = stats.supplies.grenade || 0;
                elements.goldBox.textContent = stats.supplies.goldBox || 0;
                elements.overdrive.textContent = stats.supplies.overdrive || 0;
            }
            
            // Обновляем никнейм в профиле
            elements.tankiNickname.textContent = stats.player_name;
            elements.tankiRank.textContent = stats.rank;
        }
        
        // Обновление топовых предметов
        function updateTopItems(containerId, items, iconClass) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = items.map((item, index) => `
                <div class="top-item">
                    <div class="top-icon">
                        <i class="${iconClass}"></i>
                    </div>
                    <div class="top-info">
                        <div class="top-name">${item[0]}</div>
                        <div class="top-value">${item[1]} ч</div>
                    </div>
                </div>
            `).join('');
        }
        
        // Переключение вкладок
        function setupTabNavigation() {
            const tabItems = document.querySelectorAll('.tab-item');
            
            tabItems.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Убираем активный класс со всех вкладок
                    tabItems.forEach(item => item.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Добавляем активный класс текущей вкладке
                    this.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }
        
        // Переключение темы
        function setupThemeSwitcher() {
            elements.themeSwitch.addEventListener('change', function() {
                if (this.checked) {
                    document.body.classList.add('dark-theme');
                    localStorage.setItem('theme', 'dark');
                } else {
                    document.body.classList.remove('dark-theme');
                    localStorage.setItem('theme', 'light');
                }
            });
            
            // Загрузка сохраненной темы
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                elements.themeSwitch.checked = true;
                document.body.classList.add('dark-theme');
            }
        }
        
        // Обработчик привязки аккаунта ТО
        async function handleBindAccount() {
            const nickname = elements.nicknameInput.value.trim();
            if (!nickname) {
                showToast('Введите никнейм', 'error');
                return;
            }
            
            // Простая валидация никнейма
            if (!/^[a-zA-Z0-9_]{3,16}$/.test(nickname)) {
                showToast('Никнейм может содержать только буквы, цифры и _ (3-16 символов)', 'error');
                return;
            }
            
            const response = await sendApiRequest({
                action: "bind_nickname",
                nickname: nickname
            });
            
            if (response && response.status === "success") {
                showToast('Никнейм привязан!', 'success');
                loadTankiStats(nickname);
            } else {
                showToast(response?.error || 'Ошибка привязки никнейма', 'error');
            }
        }
        
        // Загрузка статистики ТО
        async function loadTankiStats(nickname) {
            const data = await sendApiRequest({
                action: "get_tanki_stats",
                nickname: nickname
            });
            
            if (data && data.success) {
                updateTankiStats(data);
            } else {
                showToast(data?.error || 'Ошибка загрузки данных', 'error');
            }
        }
        
        // Обработчик поиска игрока в рейтинге
        async function handlePlayerSearch() {
            const nickname = elements.ratingNicknameInput.value.trim();
            if (!nickname) {
                showToast('Введите никнейм игрока', 'error');
                return;
            }
            
            const data = await sendApiRequest({
                action: "get_tanki_stats",
                nickname: nickname
            });
            
            if (data && data.success) {
                updatePlayerStats(data);
                showToast(`Данные для ${nickname} загружены`, 'success');
            } else {
                showToast(data?.error || 'Ошибка загрузки данных', 'error');
            }
        }
        
        // Обновление статистики игрока в рейтинге
        function updatePlayerStats(stats) {
            if (!stats) return;
            
            // Основная статистика
            elements.playerBattles.textContent = stats.battles.toLocaleString();
            elements.playerWins.textContent = stats.wins.toLocaleString();
            elements.playerWinrate.textContent = `${stats.winrate}%`;
            elements.playerDestroyed.textContent = stats.kills.toLocaleString();
            elements.playerExperience.textContent = stats.experience.toLocaleString();
            
            // Топы
            updatePlayerTopItems('playerTopGuns', stats.turrets, 'fas fa-gun');
            updatePlayerTopItems('playerTopHulls', stats.hulls, 'fas fa-shield-alt');
            updatePlayerTopItems('playerTopPaints', stats.paints, 'fas fa-paint-roller');
            
            // Припасы
            if (stats.supplies) {
                elements.playerRepairKit.textContent = stats.supplies.repairKit || 0;
                elements.playerArmor.textContent = stats.supplies.armor || 0;
                elements.playerDoubleDamage.textContent = stats.supplies.doubleDamage || 0;
                elements.playerSpeedBoost.textContent = stats.supplies.speedBoost || 0;
            }
            
            // Показываем все разделы
            elements.playerStats.style.display = 'block';
            elements.playerRatings.style.display = 'block';
            elements.playerTops.style.display = 'block';
            elements.playerSupplies.style.display = 'block';
        }
        
        // Обновление топовых предметов игрока
        function updatePlayerTopItems(containerId, items, iconClass) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = items.map((item, index) => `
                <div class="top-item">
                    <div class="top-icon">
                        ${index + 1}
                    </div>
                    <div class="top-info">
                        <div class="top-name">${item[0]}</div>
                        <div class="top-value">${item[1]} ч</div>
                    </div>
                </div>
            `).join('');
        }
        
        // Инициализация приложения
        async function initApp() {
            // Настройка Telegram WebApp
            if (tg.platform !== 'unknown') {
                tg.expand();
                tg.enableClosingConfirmation();
                tg.setHeaderColor('#00897B');
                tg.setBackgroundColor('#F5F7FA');
            }
            
            // Получаем данные пользователя
            const user = tg.initDataUnsafe.user;
            updateProfileHeader(user);
            
            // Загружаем статистику чата
            const chatStats = await sendApiRequest({
                action: "get_chat_stats"
            });
            
            if (chatStats && !chatStats.error) {
                updateChatStats(chatStats);
            }
            
            // Настройка интерфейса
            setupTabNavigation();
            setupThemeSwitcher();
            
            // Обработчики событий
            elements.bindBtn.addEventListener('click', handleBindAccount);
            elements.ratingSearchBtn.addEventListener('click', handlePlayerSearch);
            
            // Загрузка сохраненных настроек приватности
            const privacySetting = localStorage.getItem('privacy');
            if (privacySetting === 'hidden') {
                elements.privacySwitch.checked = true;
            }
            
            const showGameSetting = localStorage.getItem('showGameAccount');
            if (showGameSetting === 'false') {
                elements.showGameAccount.checked = false;
            }
            
            // Обработчики для настроек
            elements.privacySwitch.addEventListener('change', function() {
                localStorage.setItem('privacy', this.checked ? 'hidden' : 'visible');
                showToast(this.checked ? 'Профиль скрыт' : 'Профиль виден всем', 'success');
            });
            
            elements.showGameAccount.addEventListener('change', function() {
                localStorage.setItem('showGameAccount', this.checked);
                showToast(this.checked ? 'Игровой аккаунт виден' : 'Игровой аккаунт скрыт', 'success');
            });
            
            // Обработчик поиска пользователей
            elements.userSearchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    showToast(`Поиск пользователя: ${this.value}`, 'info');
                }
            });
        }
        
        // Запуск приложения
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
